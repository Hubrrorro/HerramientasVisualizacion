<!DOCTYPE html>
<html>
  <head>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href='https://fonts.googleapis.com/css?family=Lobster' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Rajdhani' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link rel="stylesheet" href="Css/Style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta charset="UTF-8">
    <style>
      .spanColor{
        width: 20px; 
        height: 20px; 
        border-radius: 5px; 
        border: gray; 
        margin-top: 15px;
        margin-left: 5px;
      }
      .divColor{
     display:-webkit-box;
  display:-webkit-flex;
  display:-ms-flexbox;
  display:flex;
    }
    svg{ 
      margin: auto;
    }
      #button{
        cursor: pointer;
      }
      .graphe_container{
       -moz-transform-origin: 160px 160px;
        -ms-transform-origin:  160px 160px;
        -o-transform-origin: 160px 160px;
        -webkit-transform-origin:  160px 160px;
        transform-origin: 160px 160px;
      }
      rect,circle{
        user-select: none;
        -webkit-user-select:none;
        -moz-user-select:none;
      }
    </style>
  </head>

  <body>
    <header>
        <div class="container"><a href="#" data-target="nav-mobile" class="top-nav sidenav-trigger waves-effect waves-light circle hide-on-large-only"><i class="material-icons">menu</i></a></div>
        <ul id="nav-mobile" class="sidenav sidenav-fixed backgroundlateral">
        </ul>
         
      </header>

      <main>     
         
        <div class="container">
            <div class="row center ">
                <div class="col s12 imgenCentro ">
                  <img class="responsive-img"  src="Images/logo.png">
                  <h1 class="titulo">Afluencia preliminar en transporte público - 2020</h1>
                  <a href="https://datos.cdmx.gob.mx/explore/dataset/afluencia-preliminar-en-transporte-publico">Los datos provienen en tiempo real de la siguiente página de CDMX GOB</a>
                </div>
            </div>
          <div class="row center">
            <div class="col s12">
                <h2 class="titulo">Filtros</h2>
            </div>
            <div class="col s4 m4 l4">
                <div class="input-field">
                    <select id="ddlMes" >
                      <option value="03" selected>Marzo</option>
                      <option value="04">Abril</option>
                      <option value="05">Mayo</option>
                      <option value="06">Junio</option>
                      <option value="07">Julio</option>
                      <option value="08">Agosto</option>
                      <option value="09">Septiembre</option>
                      <option value="10">Obtubre</option>
                      <option value="11">Noviembre</option>
                      <option value="12">Diciembre</option>
                    </select>
                    <label>Selecciona el mes:</label>
                  </div>
            </div>
            <div class="col s4 m4 l4">
                <div class="input-field">
                    <select id="ddlDia" >
                    </select>
                    <label>Selecciona el dia:</label>
                  </div>
            </div>
            
            <div class="col s12 m12 l12">
              <label>Da clic en el color para cambiar el color de la gráfica</label>
            </div>
            <div class="col s12 m12 l12">
              <div class="row">
                
            <div class="col s4 m2 l2" style="display:flex">
                <p>
                    <label>
                      <input id="Todos" class="rbfiltro" name="group1" type="radio" value="Todos" checked />
                      <span>Todos</span>
                    </label>
                    
                  </p>
            </div>
            <div class="col s4 m2 l2" style="display:flex">
                <p>
                    <label>
                      <input id="checkEcobici" class="rbfiltro" name="group1" value="Ecobici"  type="radio" />
                      <span>Ecobici</span>
                    </label>
                    <div id="checkEcobiciColor" class="spanColor" ></div>
                  </p>
            </div>
            <div class="col s4 m2 l2"  style="display:flex">
                <p>
                    <label>
                      <input id="checkMetrobus" class="rbfiltro" name="group1" value="Metrobús"  type="radio" />
                      <span>Metrobús</span>
                    </label>
                    <div id="checkMetrobusColor" class="spanColor" ></div>
                  </p>
            </div>
            <div class="col s4 m2 l2" style="display:flex">
                <p>
                    <label>
                      <input id="checkRTP" class="rbfiltro" name="group1" type="radio" value="RTP" />
                      <span>RTP</span>
                    </label>
                    <div id="checkRTPColor" class="spanColor" ></div>
                  </p>
            </div>
            <div class="col s4 m2 l2"  style="display:flex">
                <p>
                    <label>
                      <input id="checkSTC" class="rbfiltro" name="group1"  type="radio" value="STC" />
                      <span>STC</span>
                    </label>
                    <div id="checkSTCColor" class="spanColor" ></div>
                  </p>
            </div>
            <div class="col s4 m2 l2"  style="display:flex">
                <p>
                    <label>
                      <input id="checkSTE" class="rbfiltro" name="group1"  type="radio" value="STE-Trolebús" />
                      <span>STE-Trolebús</span>
                    </label>
                    <div id="checkSTEColor" class="spanColor" ></div>
                  </p>
            </div>
            
          </div>
          </div>
        </div>
          <div class="row center">
              <div class="col s12 m12 l12">
                <div id="grafica" class="grafica z-depth-4"></div>
              </div>
          </div>
        </div>
        

        <div id="modal1" class="modal">
          <div class="modal-content">
            <h6 id="titulocolor">Elige un color a tu gráfica</h4>
              <a href="https://bl.ocks.org/adnenre/8fae80314887a4554db99268c1d7041e">Implementación de paleta svg por Adnen rebai’s...</a>
              <input type="hidden" id="hdvalor">
            <div id="colorPicker" class="divColor"></div>
          </div>
        </div>

    </main>
    <script
    src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
    crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="Scripts/variables.js"></script>
    <script src="Scripts/paginas.js"></script>
    <script src="Scripts/menu.js"></script>
    <script>
      $('.spanColor').click(function(){
        $('#modal1').modal();
        var nombreid= this.id;
        var check = nombreid.replace('Color','');
        var valor =$('#'+  check).val();
        $('#hdvalor').text(valor);
        $('#titulocolor').text('Elige un color para tus barras de '+ valor);
        draw_palet();
        open_palet();
        $('#modal1').modal('open');
      });
      function FncmuestraColor()
      {
        $('#checkEcobiciColor').attr('style',  'background-color:' + arrayOrganismo.find( org => org.organismo === 'Ecobici').color);
        $('#checkMetrobusColor').attr('style',  'background-color:' + arrayOrganismo.find( org => org.organismo === 'Metrobús').color);
        $('#checkRTPColor').attr('style',  'background-color:' + arrayOrganismo.find( org => org.organismo === 'RTP').color);
        $('#checkSTCColor').attr('style',  'background-color:' + arrayOrganismo.find( org => org.organismo === 'STC').color);
        $('#checkSTEColor').attr('style',  'background-color:' + arrayOrganismo.find( org => org.organismo === 'STE-Trolebús').color);
      }
        var _nombreCurso ,_docente,_alumno;
        FncCargaVariables();
        FncCreaMenu('nav-mobile');
        const arrayOrganismo = [{organismo: 'Ecobici', color:'#88cc44'}, 
        {organismo: 'Metrobús', color:'#1199ff'},
        {organismo: 'RTP', color:'#ff9900'},
        {organismo: 'STC', color:'#ff4422'},
        {organismo: 'STE-Trolebús', color:'#999999'}];
        var ancho = +d3.select(".grafica").style('width').slice(0,-2);
          var alto = +d3.select(".grafica").style('height').slice(0,-2);
          
          var margin = {top: 30, right: 30, bottom: 70, left: 60},
          width = ancho - margin.left - margin.right,
          height = 600 - margin.top - margin.bottom;
          
          var svg = d3.select("#grafica")
            .append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
            .append("g")
              .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");
            // Initialize the X axis
var x = d3.scaleBand()
  .range([ 0, width ])
  .padding(0.2);
var xAxis = svg.append("g")
  .attr("transform", "translate(0," + height + ")")

// Initialize the Y axis
var y = d3.scaleLinear()
  .range([ height, 0]);
var yAxis = svg.append("g")
  .attr("class", "myYaxis")

  $('#ddlMes').change( function(){
              BuscarDatos();
            });
  $('#ddlDia').change( function(){
              BuscarDatos();
            });
        $(document).ready(function(){
            $('.materialboxed').materialbox();
            $('.collapsible').collapsible();
            $('select').formSelect();
            FncCargaDias();
            $('.sidenav').sidenav();
            BuscarDatos();
            FncmuestraColor();

        });
        function FncCargaDias()
        {
            var mesint = parseInt($('#ddlMes').val());
            var fecha = new Date(2020, mesint,1);
            d = new Date(fecha - 1);
            FncAgregaOption(d.getDate());
        }
        $('#ddlMes').on('change', function(){
            FncCargaDias();
        });
        function FncAgregaOption(diamax)
        {
            $('#ddlDia').html('');
            var i;
            for (i = 1; i <= diamax; i++) {
                if (i < 10)
                    $('#ddlDia').append('<option value="0'+ i +'">' + i + '</option>');
                else
                    $('#ddlDia').append('<option value="'+ i +'">' + i + '</option>');
            }
            $('select').formSelect();  
            
        }
        $('#btnbuscar').click(function(){
            BuscarDatos();
        });
        var datos;
        function BuscarDatos(){
            var mes = $('#ddlMes').val();
            var dia = $('#ddlDia').val();
            var urlDatos = "https://datos.cdmx.gob.mx/api/records/1.0/search/?dataset=afluencia-preliminar-en-transporte-publico&q=&rows=1000&facet=fecha&facet=mes&facet=organismo&facet=dia_mes_&refine.mes=2020-"+ mes +"&refine.dia_mes_=" + dia;
            d3.json(urlDatos, function(error, data){
                if(error)
                    {
                        return console.error(error);
                    }
                    datos= data.records;
                    render(data.records);
            });
        }
        function render(data){
              x.domain(data.map(function(d){ return d.fields.organismo + '-' + d.fields.linea_servicio }))
                xAxis.call(d3.axisBottom(x))
                .selectAll("text")
                  .attr("transform", "translate(-10,0)rotate(-45)")
                  .style("text-anchor", "end");

                y.domain([0, d3.max(data, function(d) { return d.fields.afluencia_total_cifras_preliminares; }) ]);
                yAxis.transition().duration(1000).call(d3.axisLeft(y));


            
               var barras= svg.selectAll("rect")
                .data(data);
              barras  
                .enter()
                .append("rect")
                .merge(barras)
                .transition() 
                .duration(500)
                  .attr("x", function(d){ return x(d.fields.organismo + '-' + d.fields.linea_servicio) })
                  .attr("y", function(d){ return y(d.fields.afluencia_total_cifras_preliminares) })
                  .attr("width", x.bandwidth())
                  .attr("height", function(d) { return height - y(d.fields.afluencia_total_cifras_preliminares); })
                  .attr("fill", function(d){  
                  if (arrayOrganismo.find( org => org.organismo === d.fields.organismo)=== undefined){
                    return "#69b3a2"
                  }
                  return arrayOrganismo.find( org => org.organismo === d.fields.organismo).color })
            barras
                  .exit()
                  .remove();
                  $('.tooltipped').tooltip(); 
               
             
              // Bars
               
        }
        function filtros(){
            var selected= $('input:radio[name=group1]:checked').val();
            

            var d= datos.filter(function(d,i){
                if (selected== "Todos")
                    return datos;   

                return d.fields.organismo == selected;
                })
            render(d)
        }
        $('.rbfiltro').click(function(){
            filtros();
        });
      
///////Palet
var svg2 = d3.select('#colorPicker').append('svg')
                            .attr('width',320)
                            .attr('height',600);

 var x1 = 160,
     y1 = 150;  
     var c_color ;
     var color_is_choosed = false;
     var colors = [
     '#ff4422','#ee1166' ,'#9911bb' ,'#6633bb' ,'#3344bb' ,'#1199ff','#00aaff',
     '#00bbdd','#009988','#44bb44','#88cc44','#ccdd22','#ffee11','#ffcc00','#ff9900','#ff5500',
     '#775544','#999999','#828080','#444'];
      var palet= d3.select('#colorPicker').select('svg');

function deg_color(color){
  
  return d_color = [
     d3.hsl(color).darker(0.5),
     d3.hsl(color).darker(0.3),
     color,
     d3.hsl(color).brighter(0.5),
     d3.hsl(color).brighter(1)
   ]

}
 function draw_palet(){

    
    var palet_container = d3.select('#colorPicker').select('svg').append('g').attr('id','palet_container');

     for(var i= 0; i<colors.length;i++){

      palet_container.append('g')
                     .attr('id','graphe_container'+i)
                     .attr('data-color',colors[i])
                     .attr('class','graphe_container');
      

      drawRect('#graphe_container'+i,x1,y1,5,5,145,20,'#fff','#ccc');                                  
      drawRect('#graphe_container'+i,x1+25,y1,4,4,20,20,deg_color(colors[i])[0],'','','color_rect color_rect0');
      drawRect('#graphe_container'+i,x1+50,y1,4,4,20,20,deg_color(colors[i])[1],'','','color_rect color_rect1'); 
      drawRect('#graphe_container'+i,x1+75,y1,4,4,20,20,deg_color(colors[i])[2],'','','color_rect color_rect2'); 
      drawRect('#graphe_container'+i,x1+100,y1,4,4,20,20,deg_color(colors[i])[3],'','','color_rect color_rect3');
      drawRect('#graphe_container'+i,x1+125,y1,4,4,20,20,deg_color(colors[i])[4],'','','color_rect color_rect4');
        
                    
     }
     drawButton();
      d3.selectAll('.color_rect').on('mouseover',mouseover);
      d3.selectAll('.color_rect').on('click',mouseClick);
 }          

 function mouseover(){
    var el = d3.select(this);
    var s_color = el.attr('fill');
                               
    setColor('#show_circle',s_color );
    d3.select('#color_code').text(s_color).attr('fill',s_color).attr('stroke',s_color); 
}
 function mouseClick(){
  
       p_color =d3.select(this.parentNode).attr('data-color');
       /*
       d3.select('#button_show_color').attr('fill',p_color);

       c_color= d3.select(this).attr('fill');
       choosed_palet.addColor(c_color);
       */
       var valor =$('#hdvalor').text();
       var itemarray =arrayOrganismo.find( org => org.organismo === valor);
       itemarray.color = p_color;
       FncmuestraColor();
       filtros();
       $('#modal1').modal('close');

}  

 function setColor(el,color){

    d3.select(el).transition().duration('200').attr('fill',color);
 }
 function drawGrapheText(x,y,id=null,value,s_color){
   var graphe = d3.select('#colorPicker').select('svg').append('g').attr('id','text_graphe');
  
        graphe.append('text')
              .attr('id',id)
              .attr('x',x)
              .attr('y',y)
              .attr('stroke',s_color)
              .text(value);
        graphe.append('line')
              .attr('x1',x)
              .attr('y1',y+5)
              .attr('x2',x-20)
              .attr('stroke',s_color)
              .attr('y2',y+20);
       graphe.append('line')
              .attr('x1',x)
              .attr('y1',y+5)
              .attr('x2',x+50)
              .attr('stroke',s_color)
              .attr('y2',y+5);
 }



 function drawCircle(container,x,y,r,color=null,id=null){
     
    
   var ele = d3.select('#colorPicker').select('svg').append('g');
   
   ele.append('circle')
             .attr('fill',color)
             .attr('id',id)
             .attr('cx',x)
             .attr('cy',y)
             .attr('stroke','#ccc')
             .attr('r',r);
  };

   function drawRect(container,x,y,rx,ry,width,height,color=null,stroke=null,id=null,classed=null){
     var ele;
      if(container == 'rect'){
        ele = d3.select('#colorPicker').select('svg').append('g');
      }else{
        ele = d3.select('#colorPicker').select('svg').select(container);
      }
      ele.append('rect') 
               .attr('id',id)
               .attr('class',classed)
               .attr('fill',color)
               .attr('stroke',stroke)
               .attr('x',x)
               .attr('y',y)
               .attr('rx',rx)
               .attr('ry',ry)
               .attr('width',width)
               .attr('height',height);
  }
  function drawButton(){

         
        drawCircle('svg',x1,y1+10,15,colors[colors.length-1],id="button_show_color");
         drawCircle('svg',x1,y1+10,10,'orange');
         drawCircle('svg',x1,y1+10,9,'white',id="button");
         d3.select('#button').on('click',buttonClicked);
  }

function buttonClicked(){
          // toggle_color('#button');
           toggle_palet();
           toggle_cirle();
           toggle_text_graphe();
           show_choosed_bar();
     };




function show_choosed_bar(){
  var last_g= colors.length-1;
  var last_color = colors[colors.length-1];
   var p_color = d3.select('#button_show_color').attr('fill');
   
    if( palet.attr('data-palet')=='on'){
      d3.selectAll('#graphe_container'+last_g).attr('data-color',last_color);
         for(var i = 0; i < 5;i++){
         
         d3.selectAll('#graphe_container'+last_g+'>.color_rect'+i).attr('fill',deg_color(last_color)[i]);
         
       }
    }else{
       d3.selectAll('#graphe_container'+last_g).attr('data-color',deg_color(p_color)[2]);
       for(var i = 0; i < 5;i++){
        d3.selectAll('#graphe_container'+last_g+'>.color_rect'+i).attr('fill',deg_color(p_color)[i]);
      }
    }
  
  
}

function toggle_color(el){
        var element = d3.select(el);
        var color = d3.select(el).attr('fill');
        if(color == 'white'){
         element.attr('fill','orange');
        }else{
          element.attr('fill','white');
        }
}

 drawCircle('circle',x1,y1+230,50,'#ccc',id='show_circle');
 drawGrapheText(x1+70,y1+200,'color_code','#cccccc','#ccc');

function toggle_cirle(){
 
       var palet= d3.select('#colorPicker').select('svg'),
       circle = d3.select('#show_circle');

     if( palet.attr('data-palet')=='on'){
          circle.transition().duration(500).attr('r',50).attr("transform", "translate(0,0)");;
     }else{
          circle.transition().duration(500).attr('r',100).attr("transform", "translate(0," + -75 + ")");
     }
}
function toggle_text_graphe(){
 
       var palet= d3.select('#colorPicker').select('svg'),
       text_graphe = d3.select('#text_graphe');

     if( palet.attr('data-palet')=='on'){
         text_graphe.transition().duration(500).attr("transform", "translate(0,0)");
     }else{
         text_graphe.transition().duration(500).attr("transform", "translate(0," + -150 + ")");
     }
}
function open_palet(){
  var step= 18;
    d3.select('#colorPicker').select('svg').attr('data-palet','on');
   
     for(var i = 0; i <colors.length ;i++){
       d3.select('#graphe_container'+i)
       .transition()
      .duration(500).attr("transform", 'rotate('+i*step+' )');
    }

}
function close_palet(){

 var el =d3.selectAll('.graphe_container');
     
      el.transition()
      .duration(500)
      .attr("transform", 'rotate('+-90+')' );
 
       
}
function toggle_palet(){
    
     if( palet.attr('data-palet')=='on'){
         close_palet();
          
         palet.attr('data-palet','off');
     }else{
         open_palet();
         palet.attr('data-palet','on');
     }
}




    </script>
  </body>
</html>